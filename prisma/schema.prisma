// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Location {
  id          String       @id @default(uuid())
  name        String       // "Saint Augustine, FL"
  zipCode     String?      @map("zip_code") // Legacy field, use zipCodes relation
  slug        String       @unique
  region      String?
  description String?
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  zipCodes    ZipCode[]
  directories Directory[]
  businesses  Business[]
  users       User[]
  contacts    Contact[]

  @@index([isActive])
  @@map("locations")
}

model ZipCode {
  id         String   @id @default(uuid())
  code       String   @unique
  locationId String   @map("location_id")
  city       String?
  state      String?
  lat        Float?
  lng        Float?
  isPrimary  Boolean  @default(false) @map("is_primary")
  createdAt  DateTime @default(now()) @map("created_at")

  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([locationId])
  @@index([state])
  @@map("zip_codes")
}

model Directory {
  id           String              @id @default(uuid())
  locationId   String              @map("location_id")
  name         String
  slug         String
  description  String?
  icon         String?             // Lucide icon name
  displayOrder Int?                @map("display_order")
  isActive     Boolean             @default(true) @map("is_active")
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")

  location            Location              @relation(fields: [locationId], references: [id])
  businesses          Business[]
  businessDirectories BusinessDirectory[]

  @@unique([locationId, slug])
  @@index([locationId, isActive])
  @@index([displayOrder])
  @@map("directories")
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  name               String?
  firstName          String?   @map("first_name")
  lastName           String?   @map("last_name")
  passwordHash       String?   @map("password_hash")
  role               String    @default("OWNER") // 'OWNER' or 'ADMIN'
  authProvider       String?   @map("auth_provider") // 'email', 'google', 'facebook'
  providerId         String?   @map("provider_id")
  emailVerified      DateTime? @map("email_verified")
  locationPreference String?   @map("location_preference")
  geolocationFlag    Boolean   @default(false) @map("geolocation_flag")
  image              String?
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  location           Location?  @relation(fields: [locationPreference], references: [id])
  businesses         Business[] @relation("BusinessOwner")
  approvedBusinesses Business[] @relation("BusinessApprover")
  contacts           Contact[]
  accounts           Account[]
  sessions           Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(uuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Business {
  id                       String    @id @default(uuid())
  ownerId                  String    @map("owner_id")
  locationId               String    @map("location_id")
  directoryId              String    @map("directory_id")
  name                     String
  slug                     String?
  description              String
  phone                    String
  website                  String?
  email                    String
  address                  String
  city                     String?
  zipCode                  String?   @map("zip_code")
  hoursJson                Json?     @map("hours_json")
  pricing                  String?
  imageUrl                 String?   @map("image_url")
  facebookUrl              String?   @map("facebook_url")
  instagramUrl             String?   @map("instagram_url")
  linkedinUrl              String?   @map("linkedin_url")
  twitterUrl               String?   @map("twitter_url")
  youtubeUrl               String?   @map("youtube_url")
  googleBusinessUrl        String?   @map("google_business_url")
  tiktokUrl                String?   @map("tiktok_url")
  status                   String    @default("PENDING") // 'PENDING', 'APPROVED', 'REJECTED'
  isActive                 Boolean   @default(true) @map("is_active") // Admin can deactivate approved businesses
  rejectionReason          String?   @map("rejection_reason")
  businessRegistrationNumber String? @map("business_registration_number")
  duplicateFlag            Boolean   @default(false) @map("duplicate_flag")
  duplicateNotes           String?   @map("duplicate_notes")
  potentialDuplicates      String[]  @default([]) @map("potential_duplicates")
  createdAt                DateTime  @default(now()) @map("created_at")
  updatedAt                DateTime  @updatedAt @map("updated_at")
  approvedAt               DateTime? @map("approved_at")
  approvedBy               String?   @map("approved_by")

  owner               User                @relation("BusinessOwner", fields: [ownerId], references: [id])
  location            Location            @relation(fields: [locationId], references: [id])
  directory           Directory           @relation(fields: [directoryId], references: [id])
  approver            User?               @relation("BusinessApprover", fields: [approvedBy], references: [id])
  businessDirectories BusinessDirectory[]

  @@unique([ownerId, name, locationId])
  @@unique([locationId, directoryId, slug])
  @@index([locationId, directoryId, status])
  @@index([ownerId, status])
  @@index([status, createdAt])
  @@index([approvedAt])
  @@index([isActive])
  @@index([slug])
  @@index([duplicateFlag])
  @@map("businesses")
}

model BusinessDirectory {
  id          String   @id @default(uuid())
  businessId  String   @map("business_id")
  directoryId String   @map("directory_id")
  createdAt   DateTime @default(now()) @map("created_at")

  business  Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  directory Directory @relation(fields: [directoryId], references: [id])

  @@unique([businessId, directoryId])
  @@map("business_directories")
}

model Contact {
  id         String   @id @default(uuid())
  name       String
  email      String
  subject    String?
  message    String
  locationId String?  @map("location_id")
  userId     String?  @map("user_id")
  status     String   @default("NEW") // 'NEW', 'READ', 'RESOLVED'
  createdAt  DateTime @default(now()) @map("created_at")

  location Location? @relation(fields: [locationId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])

  @@index([status, createdAt])
  @@index([userId])
  @@map("contacts")
}
